<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Firebase ‚Üí Supabase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f7f9fc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        .section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .file-input {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            cursor: pointer;
            background: white;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .warning strong {
            display: block;
            margin-bottom: 5px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Migration Firebase ‚Üí Supabase</h1>
        <p class="subtitle">Outil de migration des donn√©es des backups Firebase vers Supabase</p>

        <div class="warning">
            <strong>‚ö†Ô∏è Avant de commencer :</strong>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Assurez-vous d'avoir ex√©cut√© le script SQL <code>supabase-schema.sql</code> dans Supabase</li>
                <li>Configurez votre cl√© API dans <code>supabase-config.js</code></li>
                <li>Cette op√©ration va importer les donn√©es des joueurs depuis les backups</li>
                <li><strong>Important:</strong> Les utilisateurs doivent se reconnecter apr√®s l'import pour lier leurs comptes Supabase Auth. Les donn√©es ne seront pas visibles tant qu'ils ne se sont pas reconnect√©s.</li>
            </ul>
        </div>

        <div class="section">
            <h2>üì¶ 1. Importer les donn√©es des joueurs</h2>
            <p>S√©lectionnez le fichier <code>backups/backup_players.json</code></p>
            <div class="file-input">
                <label for="players-file">Fichier backup_players.json :</label>
                <input type="file" id="players-file" accept=".json">
            </div>
            <button id="import-players-btn" onclick="importPlayers()">Importer les joueurs</button>
        </div>

        <div class="progress" id="progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="status" id="status"></div>

        <div class="section">
            <h2>üìä Statistiques</h2>
            <p id="stats">Aucune importation effectu√©e</p>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        import { SUPABASE_CONFIG } from './supabase-config.js';

        const supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
        }

        function updateProgress(percent) {
            const progress = document.getElementById('progress');
            const bar = document.getElementById('progress-bar');
            progress.style.display = 'block';
            bar.style.width = percent + '%';
        }

        window.importPlayers = async function() {
            const fileInput = document.getElementById('players-file');
            const btn = document.getElementById('import-players-btn');
            
            if (!fileInput.files.length) {
                showStatus('‚ö†Ô∏è Veuillez s√©lectionner un fichier', 'error');
                return;
            }

            btn.disabled = true;
            showStatus('üìñ Lecture du fichier...', 'info');

            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const players = JSON.parse(text);

                showStatus(`üîÑ Import de ${players.length} joueurs en cours...`, 'info');
                updateProgress(0);

                let imported = 0;
                let errors = 0;
                let skipped = 0;

                for (let i = 0; i < players.length; i++) {
                    const player = players[i];
                    
                    try {
                        // Mapping des champs Firebase vers Supabase
                        const playerData = {
                            email: player.email,
                            collection: player.collection || [],
                            packs_by_gen: player.packsByGen || player.packs_by_gen || {},
                            last_draw_time: player.lastDrawTime || player.last_draw_time || 0,
                            available_packs: player.availablePacks || player.available_packs || 3,
                            role: player.role || 'player',
                            points: player.points || 0,
                            bonus_packs: player.bonusPacks || player.bonus_packs || 0,
                            current_booster: player.currentBooster || player.current_booster || [],
                            booster_revealed_cards: player.boosterRevealedCards || player.booster_revealed_cards || [],
                            notifications_enabled: player.notificationsEnabled || player.notifications_enabled || false,
                            admin_notification: player.adminNotification || player.admin_notification || null
                        };

                        // Note: user_id sera null car on n'a pas d'utilisateur Firebase Auth ici
                        // Les utilisateurs devront se reconnecter pour cr√©er leur compte Supabase
                        // On stocke l'email pour r√©f√©rence

                        // V√©rifier si le joueur existe d√©j√† (par email)
                        const { data: existing } = await supabase
                            .from('players')
                            .select('id')
                            .eq('email', player.email)
                            .single();

                        if (existing) {
                            // Update existing player
                            await supabase
                                .from('players')
                                .update(playerData)
                                .eq('id', existing.id);
                            imported++;
                        } else {
                            // Create note: this will fail without user_id, 
                            // users need to login first to create auth accounts
                            console.log(`Skipping ${player.email} - user must login first`);
                            skipped++;
                        }

                        updateProgress(Math.round((i + 1) / players.length * 100));
                    } catch (err) {
                        console.error(`Erreur pour ${player.email}:`, err);
                        errors++;
                    }
                }

                updateProgress(100);
                showStatus(
                    `‚úÖ Migration termin√©e ! ${imported} joueurs mis √† jour, ${skipped} ignor√©s (doivent se connecter d'abord), ${errors} erreurs.
                    
                    ‚ö†Ô∏è Note: Les ${skipped} joueurs ignor√©s doivent se connecter pour cr√©er leurs comptes Supabase Auth.`,
                    'success'
                );
                document.getElementById('stats').innerHTML = `
                    <strong>Import termin√© :</strong><br>
                    ‚úÖ ${imported} joueurs mis √† jour<br>
                    ‚è≠Ô∏è ${skipped} joueurs ignor√©s (doivent se connecter)<br>
                    ${errors > 0 ? `‚ùå ${errors} erreurs<br>` : ''}
                    üìß Les ${skipped} joueurs ignor√©s doivent se connecter pour cr√©er leur compte Supabase Auth avant que leurs donn√©es puissent √™tre import√©es
                `;

            } catch (error) {
                console.error(error);
                showStatus(`‚ùå Erreur: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // Test de connexion Supabase
        (async () => {
            try {
                const { error } = await supabase.from('players').select('count').limit(1);
                if (error) {
                    if (error.message.includes('JWT')) {
                        showStatus('‚ö†Ô∏è Configuration Supabase manquante. V√©rifiez supabase-config.js', 'error');
                    } else {
                        showStatus('‚ö†Ô∏è Erreur de connexion √† Supabase: ' + error.message, 'error');
                    }
                } else {
                    showStatus('‚úÖ Connexion √† Supabase OK', 'success');
                    setTimeout(() => {
                        document.getElementById('status').style.display = 'none';
                    }, 3000);
                }
            } catch (e) {
                showStatus('‚ùå Impossible de se connecter √† Supabase. V√©rifiez votre configuration.', 'error');
            }
        })();
    </script>
</body>
</html>
